<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hanzi Kaligrafi - Mode Landscape</title>

  <!-- --- Tailwind CSS CDN --- -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- --- Tailwind Configuration --- -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Skema warna tema Cina
            'china-red': '#B22222', // Merah Tua / Firebrick
            'lucky-red': '#E4002B', // Merah Terang
            'pshuffleBtnrosperity-gold': '#FFD700', // Emas
            'bg-light': '#FAF9F6', // Putih gading, seperti kertas
            'bg-pattern': '#f7f2ed', // Latar belakang bertekstur lembut
          },
          fontFamily: {
            sans: ['Inter', 'Noto Sans CJK SC', 'system-ui', 'sans-serif'],
            title: ['Georgia', 'serif'],
          }
        }
      }
    }
  </script>

  <!-- Custom Style untuk layout Landscape Datar dan Kanvas 16:9 -->
  <style>
    /* Mengatur ukuran body/html agar sesuai dengan mode layar penuh */
    html, body {
        height: 100%;
        width: 100%;
    }
    .bg-bg-pattern {
        background-color: #f7f2ed;
    }

    /* Container utama (Layout grid 3 kolom untuk desktop/landscape) */
    #appContainer {
      width: 1500px;
      max-width: 100vw;
      height: 640px;
      max-height: 100vh;
      display: grid;
      /* Grid 3 kolom: Panel Kiri (250px), Kanvas Tengah (Fleksibel), Panel Kanan (250px) */
      grid-template-columns: 250px 1fr 250px;
      gap: 30px;
      padding: 30px;
    }

    /* Kanvas Persegi Panjang (Rasio ~16:9) */
    #canvasWrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        max-width: 900px;
        max-height: 580px;
        margin: 0 auto;
    margin-top: -20px;
    }
    #canvasContainer {
      width: 100%;
      padding-bottom: 56.25%; /* Rasio 16:9 */
      position: relative;
    }
    #drawCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      touch-action: none; /* Mencegah gulir pada sentuhan */
      background-color: white;
      border: 6px solid #ccc;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    /* Styling tombol yang lebih besar dan touch-friendly */
    .action-btn {
        min-height: 52px;
        padding: 1rem;
    }

    /* Media Query untuk Mobile/Tablet (Bukan Landscape Datar) */
    @media (max-width: 1024px) {
        #appContainer {
            width: 100vw;
            height: 100vh;
            grid-template-columns: 1fr; /* Tumpuk semua kolom */
            grid-template-rows: auto 1fr auto; /* Panel Kiri, Kanvas, Panel Kanan */
            gap: 20px;
            padding: 20px;
        }

        #canvasWrapper {
            max-width: 90vw;
            max-height: none;
            height: auto;
        }
    }
    
    /* Style untuk Toast (Notifikasi) */
    #toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .toast {
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
  </style>

</head>
<body class="bg-bg-pattern flex items-start justify-center p-4 font-sans text-gray-800 selection:bg-prosperity-gold selection:text-china-red overflow-auto">

  <!-- Container Utama Aplikasi -->
  <div id="appContainer" class="bg-white rounded-xl shadow-2xl border-4 border-lucky-red transform transition-all duration-300">

    <!-- 1. Panel Kiri (Pinyin Display & Jawaban) -->
    <div class="flex flex-col h-full p-4 border-r border-gray-200">
        <h1 class="text-3xl font-title font-bold text-china-red mb-4 tracking-wider text-center">
            <span class="text-prosperity-gold drop-shadow-sm">Ê±âÂ≠ó</span> Kaligrafi
        </h1>

        <!-- Display Pinyin (Instruksi) -->
        <div class="flex flex-col justify-center items-center p-4 bg-gray-50/70 rounded-xl mb-4 shadow-inner">
<!-- Progress Kata Baru -->
<div class="mt-3 p-3 bg-white rounded-xl border shadow-sm">
  <div class="flex justify-between text-xs text-gray-500 mb-1">
    <span>Progres Kata Baru</span>
    <span id="progressText">0 / 0</span>
  </div>
  <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
    <div
      id="progressBar"
      class="h-full bg-lucky-red transition-all duration-300"
      style="width: 0%"
    ></div>
  </div>
</div>
            <label class="text-sm font-semibold text-gray-500 mb-2 uppercase">Paket Aktif: <span id="activePackageNameDisplay" class="font-bold text-lucky-red"></span></label>
            <div class="min-h-[100px] flex flex-col items-center justify-center text-center select-none leading-none">
                <div id="mainPinyinDisplay" class="text-4xl font-extrabold text-lucky-red leading-tight">
                    Tekan Acak
                </div>
                <div id="notePinyinDisplay" class="text-base text-gray-500 font-medium mt-2">
                    <!-- Catatan dalam kurung akan muncul di sini -->
                </div>
            </div>
        </div>

        <!-- Tampilkan Jawaban (Hanzi) -->
        <div id="answerContainer"
     class="w-full min-h-[100px] mt-2 hidden">
            <div class="text-center p-3 border-4 border-dashed border-prosperity-gold rounded-xl bg-yellow-50/50">
                <p class="text-lg font-bold text-china-red">Jawaban Hanzi:</p>
                <div id="hanziDisplay" class="text-6xl font-title text-lucky-red mt-1 leading-none"></div>
            </div>
        </div>

        <!-- Pesan Status IDB/Offline -->
        <div id="statusMessage" class="mt-2 text-xs text-center text-gray-400">
            <!-- Pesan status IndexedDB akan muncul di sini -->
        </div>
<!-- Tombol Kelola Data (dipindah ke kiri kanvas) -->
<button id="manageBtn"
  class="action-btn w-full mt-4 py-3 px-4 bg-gray-200 text-gray-700 rounded-xl
         hover:bg-gray-300 transition duration-200 text-base font-medium
         flex flex-col items-center justify-center gap-1 text-center">
  ‚úèÔ∏è Kelola Data <span>(<span id="dataCount">0</span>)</span>
<p id="emptyDataMsg" class="mt-2 text-gray-500 text-center hidden">
  Data kosong. Tambahkan data baru.
</p>
</button>
    </div>

    <!-- 2. Kolom Tengah (Kanvas Menggambar) -->
    <div class="flex items-start justify-center h-full pt-4">
        <div id="canvasWrapper" class="flex flex-col">
            <div id="canvasContainer" class="rounded-xl overflow-hidden shadow-2xl">
                <!-- Ukuran ini hanya default, akan dihitung ulang oleh JS -->
                <canvas id="drawCanvas" width="900" height="506.25"></canvas>
            </div>
        </div>
    </div>

    <!-- 3. Panel Kanan (Tombol Aksi & Pengaturan) -->
    <div class="flex flex-col h-full p-4 border-l border-gray-200">
        <h2 class="text-xl font-title font-bold text-china-red mb-4 border-b pb-2">Kontrol Aksi</h2>

        <!-- Tombol Aksi Utama -->
        <div class="w-full space-y-4 mb-8">
            <button id="shuffleBtn" class="action-btn w-full bg-lucky-red text-white rounded-xl shadow-xl hover:bg-china-red transition duration-200 font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02]">
                üîÄ Acak Kata Baru
            </button>

            <button id="showAnswerBtn" class="action-btn w-full bg-prosperity-gold text-china-red rounded-xl shadow-lg hover:bg-yellow-600 transition duration-200 font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02]">
                üëÄ Tampilkan Jawaban
            </button>
        </div>

        <h2 class="text-xl font-title font-bold text-china-red mb-4 border-b pb-2">Alat & Pengaturan</h2>

        <!-- Tombol Hapus Gambar & Opsi Pengaturan -->
        <div class="w-full space-y-4 mb-6">
            <button id="clearBtn" class="action-btn w-full bg-white text-china-red border-2 border-china-red rounded-xl shadow-md hover:bg-china-red hover:text-white transition duration-200 font-semibold text-lg">
                üóëÔ∏è Hapus Gambar
            </button>

            <!-- NEW: Package Selector -->
            <div class="p-4 border rounded-xl bg-gray-50">
                <h3 class="font-semibold text-base text-gray-700 mb-3">Pilih Paket Latihan:</h3>
                <select id="packageSelector" class="w-full p-2 border rounded-lg focus:ring-lucky-red focus:border-lucky-red text-base">
                    <!-- Options will be injected by JS -->
                </select>
            </div>

            <div class="p-4 border rounded-xl bg-gray-50"
               <label for="allowRepeat" class="flex items-center cursor-pointer">
                    <input type="checkbox" id="allowRepeat" class="h-5 w-5 text-lucky-red border-gray-300 rounded focus:ring-lucky-red" checked>
                    <span class="ml-3 select-none text-base font-medium">ulang</span>
                </label>
            </div>
        </div>
  <!-- Modal untuk Kelola Data -->
  <div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
    <div id="modalContent" class="bg-white p-6 rounded-xl w-full max-w-3xl shadow-2xl border-4 border-china-red transform scale-100 transition-all duration-300 overflow-y-auto max-h-[90vh]">
      <h2 class="text-2xl font-bold font-title mb-4 text-china-red border-b pb-2">Kelola Paket & Data Hanzi</h2>

      <!-- NEW: Package Management -->
      <div class="mb-6 p-4 border-2 border-dashed border-china-red rounded-xl bg-red-50/50">
        <h3 class="font-semibold text-lg mb-3 text-lucky-red">Manajemen Paket</h3>

        <div class="flex gap-4 mb-4">
            <input type="text" id="newPackageName" class="flex-grow p-2 border rounded-lg text-base focus:ring-lucky-red focus:border-lucky-red" placeholder="Nama Paket Baru (e.g., Konjungsi)">
            <button id="addPackageBtn" class="bg-lucky-red text-white px-4 py-2 rounded-xl font-bold hover:bg-china-red transition duration-200 text-sm whitespace-nowrap">
                + Tambah Paket
            </button>
        </div>

        <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
            <label class="font-medium text-gray-700">Paket yang Sedang Diedit:</label>
            <span id="editingPackageName" class="font-bold text-china-red">Pilih Paket</span>
            
            <!-- NEW: Konfirmasi Hapus Paket (Menggantikan window.confirm) -->
            <div id="deleteConfirmationWrapper" class="relative">
                <button id="deletePackageBtn" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <div id="confirmDelete" class="absolute right-0 top-1/2 -translate-y-1/2 p-2 bg-red-100 border border-red-400 rounded-lg shadow-lg hidden whitespace-nowrap z-10 transform translate-x-1">
                    <span class="text-sm mr-2 text-red-700">Yakin hapus?</span>
                    <button id="confirmYes" class="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600">Ya</button>
                    <button id="confirmNo" class="bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded hover:bg-gray-400 ml-1">Batal</button>
                </div>
            </div>
            
        </div>
      </div>

      <!-- Form Tambah Data Multi-Baris (Kini hanya untuk paket yang diedit) -->
      <div id="pairInputContainer" class="mb-6 p-4 border-2 border-dashed border-prosperity-gold rounded-xl bg-yellow-50 grid grid-cols-2 gap-6">
        <div class="col-span-1">
            <h3 class="font-semibold text-lg mb-2 text-lucky-red">Input Pinyin</h3>
            <textarea id="inputPinyin" rows="7" class="border w-full p-3 rounded-lg text-base focus:ring-lucky-red focus:border-lucky-red resize-none" placeholder="Masukkan Pinyin (satu pasangan per baris):&#10;n«ê h«éo (halo)&#10;xi√® xie&#10;z√†i ji√†n (sampai jumpa)"></textarea>
        </div>
        <div class="col-span-1">
            <h3 class="font-semibold text-lg mb-2 text-lucky-red">Input Hanzi</h3>
            <textarea id="inputHanzi" rows="7" class="border w-full p-3 rounded-lg font-title text-xl focus:ring-lucky-red focus:border-lucky-red resize-none" placeholder="Masukkan Hanzi (satu pasangan per baris):&#10;‰Ω†Â•Ω&#10;Ë∞¢Ë∞¢&#10;ÂÜçËßÅ"></textarea>
        </div>
        <button id="saveBtn" class="col-span-2 action-btn bg-lucky-red text-white w-full py-3 rounded-xl font-bold hover:bg-china-red transition duration-200 text-lg">
          Simpan Data ke Paket Aktif
        </button>
      </div>

      <!-- Daftar Data -->
      <h3 class="font-semibold text-lg mb-2 text-china-red">Daftar Pasangan di Paket Ini (<span id="currentPackagePairCount">0</span>)</h3>
      <ul id="dataList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
        <!-- Data akan di-inject di sini -->
      </ul>

      <!-- Tombol Tutup -->
      <div class="mt-6 pt-4 border-t">
        <button id="closeModalBtn" class="action-btn bg-gray-400 text-white w-full py-3 rounded-xl hover:bg-gray-500 transition duration-200 font-medium">
          Tutup
        </button>
      </div>
    </div>
  </div>
  
  <!-- Container untuk Notifikasi (Toast) -->
  <div id="toastContainer"></div>

  <!-- --- Logika Aplikasi (JavaScript) --- -->
  <script>
    // --- IndexedDB Configuration (Penyimpanan Lokal Persisten) ---
    const DB_NAME = 'HanziKaligrafiDB';
    const STORE_NAME = 'packages'; // Object store untuk menyimpan paket kata
    const DB_VERSION = 2; // Versi database

    let db; // Variabel global untuk IndexedDB
    const statusMessage = document.getElementById('statusMessage');
    const toastContainer = document.getElementById('toastContainer'); // NEW

    // Utilitas IndexedDB (Wrapper Sederhana)
    function openDatabase() {
        return new Promise((resolve, reject) => {
            if (window.indexedDB) {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    // Hapus store lama jika ada, untuk migrasi yang bersih (Jika V1 berubah)
                    if (event.oldVersion === 1 && db.objectStoreNames.contains('hanziPairs')) {
                        db.deleteObjectStore('hanziPairs');
                    }
                    // Buat store baru/utama untuk packages
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    statusMessage.textContent = 'IndexedDB Aktif. Data tersimpan di perangkat (Offline Ready).';
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    statusMessage.textContent = 'IndexedDB GAGAL. Data tidak akan disimpan.';
                    reject(event.target.error);
                };
            } else {
                statusMessage.textContent = 'Browser Anda tidak mendukung IndexedDB.';
                reject(new Error("IndexedDB not supported"));
            }
        });
    }

    // Fungsi utilitas untuk memulai transaksi IndexedDB
    function transaction(mode) {
        if (!db) throw new Error("Database belum diinisialisasi.");
        return db.transaction([STORE_NAME], mode).objectStore(STORE_NAME);
    }

    // Mengambil semua paket data dari IndexedDB
    function loadAllPackages() {
        return new Promise((resolve, reject) => {
            try {
                const store = transaction('readonly');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            } catch(e) {
                reject(e);
            }
        });
    }

    // Menyimpan atau memperbarui paket data ke IndexedDB
    function savePackage(packageData) {
        return new Promise((resolve, reject) => {
            try {
                const store = transaction('readwrite');
                const request = store.put(packageData); // put() untuk menambah atau memperbarui berdasarkan keyPath

                request.onsuccess = () => {
                    showToast(`Paket '${packageData.name}' berhasil disimpan.`, 'success'); // Feedback
                    resolve(request.result);
                };
                request.onerror = () => {
                    showToast(`Gagal menyimpan paket '${packageData.name}'.`, 'error'); // Feedback
                    reject(request.error);
                };
            } catch(e) {
                showToast("Gagal memulai transaksi IndexedDB.", 'error');
                reject(e);
            }
        });
    }

    // Menghapus paket data dari IndexedDB berdasarkan ID
    function deletePackageFromDB(id) {
        return new Promise((resolve, reject) => {
            try {
                const store = transaction('readwrite');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            } catch(e) {
                reject(e);
            }
        });
    }

    /**
     * Menampilkan notifikasi non-blokir (Toast)
     * @param {string} message Pesan yang akan ditampilkan.
     * @param {'success'|'error'|'info'} type Jenis notifikasi.
     */
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        let bgColor = '';

        switch (type) {
            case 'success':
                bgColor = 'bg-green-500';
                break;
            case 'error':
                bgColor = 'bg-red-500';
                break;
            case 'info':
            default:
                bgColor = 'bg-gray-600';
                break;
        }

        toast.className = `toast ${bgColor}`;
        toast.textContent = message;
        toastContainer.prepend(toast); // Tambahkan di awal agar yang terbaru di atas

        // Tampilkan
        setTimeout(() => toast.classList.add('show'), 10);

        // Sembunyikan dan hapus
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Data contoh awal
    const defaultPackageName = "Dasar & Sapaan";
    const initialPairs = [
      { id: crypto.randomUUID(), a: "n«ê h«éo (halo)", b: "‰Ω†Â•Ω" },
      { id: crypto.randomUUID(), a: "xi√® xie", b: "Ë∞¢Ë∞¢" },
      { id: crypto.randomUUID(), a: "z√†i ji√†n (sampai jumpa)", b: "ÂÜçËßÅ" },
      { id: crypto.randomUUID(), a: "b√π k√® qi", b: "‰∏çÂÆ¢Ê∞î" },
      { id: crypto.randomUUID(), a: "w«í √†i n«ê (aku cinta kamu)", b: "ÊàëÁà±‰Ω†" }
    ];

    let packages = []; // Array of all packages: [{id, name, pairs}]
    let activePackageId = null;
    let activePackage = null;
    let data = []; // Pairs of the active package
    let currentPair = null;
let discoveredSet = new Set(); // ID kata yang sudah muncul

    // --- DOM Elements ---
    const mainPinyinDisplay = document.getElementById('mainPinyinDisplay');
    const notePinyinDisplay = document.getElementById('notePinyinDisplay');
    const activePackageNameDisplay = document.getElementById('activePackageNameDisplay');
    const hanziDisplay = document.getElementById('hanziDisplay');
    const answerContainer = document.getElementById('answerContainer');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const clearBtn = document.getElementById('clearBtn');
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const manageBtn = document.getElementById('manageBtn');
    const dataCount = document.getElementById('dataCount');
    const emptyDataMsg = document.getElementById('emptyDataMsg');
    const allowRepeatCheckbox = document.getElementById('allowRepeat');
    const packageSelector = document.getElementById('packageSelector'); // NEW

    const modal = document.getElementById('modal');
    const inputPinyin = document.getElementById('inputPinyin');
    const inputHanzi = document.getElementById('inputHanzi');
    const saveBtn = document.getElementById('saveBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const dataList = document.getElementById('dataList');
    const currentPackagePairCount = document.getElementById('currentPackagePairCount');

    // NEW: Package Management Modal Elements
    const newPackageNameInput = document.getElementById('newPackageName');
    const addPackageBtn = document.getElementById('addPackageBtn');
    const editingPackageName = document.getElementById('editingPackageName');
    const deletePackageBtn = document.getElementById('deletePackageBtn');
    const pairInputContainer = document.getElementById('pairInputContainer');
    
    // NEW: Delete Confirmation Elements
    const confirmDelete = document.getElementById('confirmDelete');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');

    // --- Canvas Setup (LOGIKA KUAS DAN GRID BARU) ---
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');

    /**
     * Menggambar panduan grid kaligrafi (Mi Zi Ge)
     * Garis bantu ini membagi kanvas menjadi 4 kuadran dengan diagonal putus-putus.
     */
    function drawCalligraphyGrid(canvas, ctx) {
        const w = canvas.width;
        const h = canvas.height;
        const color = 'rgba(204, 204, 204, 0.6)'; // Abu-abu muda

        // Setel ulang transformasi (penting untuk memastikan gambar tidak berulang)
        ctx.setTransform(1, 0, 0, 1, 0, 0);

        // Simpan state saat ini sebelum menggambar grid
        ctx.save();

        // 1. Garis Tengah (Horizontal dan Vertikal)
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash([]); // Pastikan solid untuk garis tengah
        ctx.beginPath();
        // Horizontal
        ctx.moveTo(0, h / 2);
        ctx.lineTo(w, h / 2);
        // Vertical
        ctx.moveTo(w / 2, 0);
        ctx.lineTo(w / 2, h);
        ctx.stroke();

        // 2. Garis Diagonal (putus-putus)
        ctx.strokeStyle = color;
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]); // Garis putus-putus
        ctx.beginPath();
        // Diagonal 1 (Top-Left to Bottom-Right)
        ctx.moveTo(0, 0);
        ctx.lineTo(w, h);
        // Diagonal 2 (Top-Right to Bottom-Left)
        ctx.moveTo(w, 0);
        ctx.lineTo(0, h);
        ctx.stroke();

        // Kembalikan state sebelumnya agar goresan pengguna tidak terpengaruh oleh lineDash
        ctx.restore();
    }

function getProgressKey(packageId) {
  return `discovered_${packageId}`;
}

function loadDiscovered(packageId) {
  const raw = localStorage.getItem(getProgressKey(packageId));
  discoveredSet = raw ? new Set(JSON.parse(raw)) : new Set();
}

function saveDiscovered(packageId) {
  localStorage.setItem(
    getProgressKey(packageId),
    JSON.stringify([...discoveredSet])
  );
}

    function setupCanvasContext() {
        // Kuas bergaya kaligrafi:
        ctx.lineWidth = 15; // Lebih tebal (dari 10) untuk kesan kuas kaligrafi
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round'; // Penting untuk sudut Hanzi yang halus
        ctx.strokeStyle = '#B22222'; // Warna coretan merah (China Red)
        
        // Panggil fungsi untuk menggambar panduan grid Hanzi
        drawCalligraphyGrid(canvas, ctx);
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Panggil setupCanvasContext lagi untuk menggambar ulang grid
      setupCanvasContext(); 
    }

    function resizeCanvas() {
        if (!canvas) return;

        let currentDrawingSnapshot = null;
        try {
            // Ambil snapshot gambar pengguna
            currentDrawingSnapshot = canvas.toDataURL();
        } catch (e) {
            console.error("Gagal membuat snapshot kanvas:", e);
        }

        const wrapper = document.getElementById('canvasWrapper');
        const availableWidth = wrapper.offsetWidth;
        const availableHeight = wrapper.offsetHeight;

        const targetRatio = 16 / 9;

        let newWidth, newHeight;

        if (availableWidth / targetRatio <= availableHeight) {
            newWidth = availableWidth;
            newHeight = availableWidth / targetRatio;
        } else {
            newHeight = availableHeight;
            newWidth = availableHeight * targetRatio;
        }

        // Hanya set jika ukurannya berubah secara signifikan
        if (canvas.width !== newWidth || canvas.height !== newHeight) {
            canvas.width = newWidth;
            canvas.height = newHeight;

            setupCanvasContext(); // Ini akan mengatur ulang kuas dan menggambar grid baru
            
            if (currentDrawingSnapshot) {
                const img = new Image();
                img.onload = function() {
                    // Gambar ulang snapshot
                    // Catatan: Gambar ulang goresan pengguna di atas grid baru
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.onerror = function() {
                    console.error("Gagal memuat snapshot kanvas.");
                };
                img.src = currentDrawingSnapshot;
            } else {
                // Jika tidak ada gambar, pastikan grid tergambar
                drawCalligraphyGrid(canvas, ctx);
            }
        }
    }

    // --- Data Storage Operations (Package Logic) ---

    // FUNGSI UTAMA: Memuat semua paket
    async function loadData() {
        try {
            await openDatabase();

            const storedPackages = await loadAllPackages();

            if (storedPackages && storedPackages.length > 0) {
                packages = storedPackages;
            } else {
                // Inisialisasi dengan paket awal jika DB kosong
                const defaultPackage = {
                    id: crypto.randomUUID(),
                    name: defaultPackageName,
                    pairs: initialPairs
                };
                packages.push(defaultPackage);
                await savePackage(defaultPackage);
            }

            // Set paket aktif: cari ID terakhir atau pilih yang pertama
            const lastActiveId = localStorage.getItem('activePackageId');
            const targetPackage = packages.find(p => p.id === lastActiveId) || packages[0];
            setActivePackage(targetPackage.id);

            populatePackageSelector();
            updateUI();
        } catch (e) {
            console.error("Gagal memuat paket data dari IndexedDB. Menggunakan data fallback.", e);
            showToast("Gagal memuat data offline. Menggunakan data sementara.", 'error');
            // Fallback (jika gagal total, buat paket default sementara)
            if (packages.length === 0) {
                packages.push({
                    id: 'fallback',
                    name: 'Fallback Data',
                    pairs: initialPairs
                });
                setActivePackage('fallback');
            }
            updateUI();
        }
    }

    // FUNGSI: Mengatur paket mana yang sedang aktif
    function setActivePackage(packageId) {
        activePackageId = packageId;
        activePackage = packages.find(p => p.id === packageId);

        if (activePackage) {
            data = activePackage.pairs || [];
            localStorage.setItem('activePackageId', packageId);
            activePackageNameDisplay.textContent = activePackage.name;
            editingPackageName.textContent = activePackage.name;
            deletePackageBtn.disabled = packages.length <= 1; // Tidak boleh hapus paket terakhir
            confirmDelete.classList.add('hidden'); // Sembunyikan konfirmasi saat ganti paket

            // Perbarui selector
            if (packageSelector.value !== packageId) {
                packageSelector.value = packageId;
            }

            shuffle(); // Acak kata baru dari paket aktif
        } else {
            // Error handling jika ID tidak ditemukan (seharusnya tidak terjadi)
            data = [];
            activePackageNameDisplay.textContent = 'Tidak Ada Paket';
            editingPackageName.textContent = 'Tidak Ada Paket';
            deletePackageBtn.disabled = true;
        }
        updateUI();
        populateDataList();
    }

    // FUNGSI: Menambahkan paket baru
    async function addNewPackage(name) {
        if (!name) return;

        const newPackage = {
            id: crypto.randomUUID(),
            name: name,
            pairs: []
        };

        packages.push(newPackage);
        try {
            await savePackage(newPackage);
            populatePackageSelector();
            setActivePackage(newPackage.id);
loadDiscovered(newPackage.id);
updateProgressUI();
        } catch (e) {
            console.error("Gagal menyimpan paket baru.", e);
            packages.pop(); // Hapus dari array lokal jika gagal simpan
        }
    }

    // FUNGSI: Menghapus paket aktif
    async function deleteActivePackage() {
        if (packages.length <= 1) {
            showToast("Tidak dapat menghapus paket terakhir.", 'info');
            return;
        }

        const packageNameToDelete = activePackage.name;
        const idToDelete = activePackageId;

        try {
            await deletePackageFromDB(idToDelete);
            packages = packages.filter(p => p.id !== idToDelete);

            // Set paket aktif ke paket pertama yang tersisa
            setActivePackage(packages[0].id);
            populatePackageSelector();
            showToast(`Paket '${packageNameToDelete}' berhasil dihapus.`, 'success');

        } catch (e) {
            console.error("Gagal menghapus paket.", e);
            showToast(`Gagal menghapus paket '${packageNameToDelete}'.`, 'error');
        }
    }


    // FUNGSI: Menambahkan pasangan data dari input multi-baris ke paket aktif
    async function addMultiLinePairs(pinyinText, hanziText) {
        if (!activePackage) return 0;

        const pinyinLines = pinyinText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const hanziLines = hanziText.split('\n').map(line => line.trim()).filter(line => line.length > 0);

        const newPairs = [];
        const maxLength = Math.min(pinyinLines.length, hanziLines.length);

        for (let i = 0; i < maxLength; i++) {
            const pinyin = pinyinLines[i];
            const hanzi = hanziLines[i];
            if (pinyin && hanzi) {
                 // Cek duplikasi berdasarkan konten di paket aktif
                const exists = activePackage.pairs.some(item => item.a === pinyin && item.b === hanzi);
                if (!exists) {
                    newPairs.push({ id: crypto.randomUUID(), a: pinyin, b: hanzi });
                } else {
                    console.log(`Pasangan duplikat ditemukan dan diabaikan: ${pinyin} - ${hanzi}`);
                }
            }
        }

        if (newPairs.length > 0) {
            activePackage.pairs.push(...newPairs);
            data = activePackage.pairs; // Update data reference
            await savePackage(activePackage); // Simpan perubahan paket ke IndexedDB
            
            // Perbarui selector agar jumlah kata diperbarui
            populatePackageSelector(); 
            
            populateDataList();
            updateUI();
            return newPairs.length;
        }
        return 0;
    }

    // FUNGSI: Menghapus pasangan data dari paket aktif
    async function deletePair(id) {
      if (!activePackage) return;

      activePackage.pairs = activePackage.pairs.filter(pair => pair.id !== id);
      data = activePackage.pairs; // Update data reference

      try {
        await savePackage(activePackage); // Simpan perubahan paket
        showToast("Pasangan kata berhasil dihapus.", 'success');
      } catch (e) {
        console.error(`Gagal menyimpan paket setelah penghapusan pasangan ID: ${id}.`, e);
        showToast("Gagal menghapus pasangan kata.", 'error');
      }

      // Jika pasangan yang sedang ditampilkan dihapus, acak yang baru
      if (currentPair && currentPair.id === id) {
        currentPair = null;
        shuffle();
      }
      
      // Perbarui selector agar jumlah kata diperbarui
      populatePackageSelector();
      
      populateDataList();
      updateUI();
    }


    // --- UI Update Functions ---
    function updateUI() {
      const dataExists = data.length > 0;

      dataCount.textContent = data.length;
      shuffleBtn.disabled = !dataExists;
      showAnswerBtn.disabled = !dataExists;
      emptyDataMsg.classList.toggle('hidden', dataExists);

      if (!dataExists) {
        mainPinyinDisplay.textContent = 'PAKET KOSONG';
        notePinyinDisplay.textContent = activePackage ? `Tambahkan data ke paket "${activePackage.name}" untuk memulai.` : '';
        answerContainer.classList.add('hidden');
      } else if (!currentPair) {
        mainPinyinDisplay.textContent = 'Tekan Acak Kata Baru';
        notePinyinDisplay.textContent = '';
        hanziDisplay.textContent = '';
      }
      currentPackagePairCount.textContent = data.length;
      deletePackageBtn.disabled = packages.length <= 1; // Perbarui status tombol hapus
updateProgressUI();
    }

    // FUNGSI: Mengisi daftar paket di selector utama dan mengaktifkan event listener
    function populatePackageSelector() {
        packageSelector.innerHTML = '';
        packages.forEach(pkg => {
            const option = document.createElement('option');
            option.value = pkg.id;
            option.textContent = `${pkg.name} (${pkg.pairs.length} kata)`;
            packageSelector.appendChild(option);
        });

        if (activePackageId) {
            packageSelector.value = activePackageId;
        }
    }

    // FUNGSI UTAMA: Menampilkan Pasangan Pinyin/Hanzi
    function showPair(pair) {
// Tandai sebagai kata baru jika belum pernah muncul
if (!discoveredSet.has(pair.id)) {
  discoveredSet.add(pair.id);
  saveDiscovered(activePackageId);
}
        currentPair = pair;

        // 1. Ekstraksi Pinyin Utama dan Teks dalam Kurung (Catatan)
        const pinyinText = pair.a;
        let mainPinyin = pinyinText.trim();
        let notePinyin = '';

        const regex = /\((.*?)\)/;
        const match = pinyinText.match(regex);

        if (match && match[1]) {
            notePinyin = match[1].toLowerCase();
            mainPinyin = pinyinText.replace(regex, '').trim();
        }

        // 2. Tampilkan di UI
        mainPinyinDisplay.textContent = mainPinyin.toUpperCase();
        notePinyinDisplay.textContent = notePinyin ? `(${notePinyin})` : '';

        // Tampilkan Hanzi Jawaban
        hanziDisplay.textContent = pair.b;
        answerContainer.classList.add('hidden');
        clearCanvas();
updateProgressUI();
    }
function updateProgressUI() {
  const total = data.length;
  const discovered = discoveredSet.size;

  const percent = total === 0 ? 0 : Math.round((discovered / total) * 100);

  document.getElementById('progressText').textContent =
    `${discovered} / ${total}`;

  document.getElementById('progressBar').style.width =
    `${percent}%`;
}

    // FUNGSI: Mengacak pasangan Hanzi baru
    function shuffle() {
  if (data.length === 0) return;

  const allowRepeat = allowRepeatCheckbox.checked;
  let pool = [];

  if (allowRepeat) {
    // Mode bebas: semua kata boleh
    pool = data;
  } else {
    // Mode belajar: hanya kata yang BELUM muncul
    pool = data.filter(p => !discoveredSet.has(p.id));

    // Jika semua kata sudah muncul ‚Üí reset progres
    if (pool.length === 0) {
      discoveredSet.clear();
      saveDiscovered(activePackageId);
      pool = data;
      showToast("Semua kata sudah muncul. Progres diulang üîÑ", "info");
    }
  }

  const pair = pool[Math.floor(Math.random() * pool.length)];
  showPair(pair);
}

    // FUNGSI: Mengisi daftar data di Modal
    function populateDataList() {
      dataList.innerHTML = '';

      if (!activePackage) {
        dataList.innerHTML = '<li class="text-center text-gray-400 py-4">Pilih atau buat paket kata untuk mengelola data.</li>';
        return;
      }

      if (data.length === 0) {
        dataList.innerHTML = `<li class="text-center text-gray-400 py-4">Paket "${activePackage.name}" kosong. Tambahkan data di atas.</li>`;
        return;
      }

      data.forEach(item => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border transition duration-150';

        li.innerHTML = `
          <span class="flex-1 mr-4 overflow-hidden">
            <span class="font-medium text-base text-gray-600 truncate block">${item.a}</span>
            <span class="block font-title text-3xl text-lucky-red leading-none">${item.b}</span>
          </span>
          <button class="delete-pair text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition duration-200" data-id="${item.id}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
            </svg>
          </button>
        `;
        dataList.appendChild(li);
      });

      // Event listener untuk hapus pasangan individual
      dataList.querySelectorAll('.delete-pair').forEach(button => {
        button.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          // Tidak perlu konfirmasi, langsung hapus karena ini hanya menghapus pasangan, bukan seluruh paket
          await deletePair(id);
        });
      });
    }

    // --- Canvas Drawing Logic ---
    let drawing = false;

    function getCanvasPosition(e) {
      const r = canvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);

      return {
        x: clientX - r.left,
        y: clientY - r.top
      };
    }

    function startDraw(e) {
      if (e.button === 0 || e.type === 'touchstart') {
        drawing = true;
        const p = getCanvasPosition(e);
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        e.preventDefault();
      }
    }

    function draw(e) {
      if (!drawing) return;
      const p = getCanvasPosition(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      e.preventDefault();
    }

    function stopDraw() {
      drawing = false;
      ctx.closePath();
    }

    // --- Event Listeners ---

    // Mouse dan Touch Events untuk menggambar
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    document.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseleave', stopDraw);

    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('touchmove', draw);
    document.addEventListener('touchend', stopDraw);
    document.addEventListener('touchcancel', stopDraw);


    shuffleBtn.addEventListener('click', shuffle);

allowRepeatCheckbox.addEventListener('change', () => {
  shuffle();
});
    clearBtn.addEventListener('click', clearCanvas);
    showAnswerBtn.addEventListener('click', () => {
      if (currentPair) {
        answerContainer.classList.toggle('hidden');
      }
    });

    // NEW: Ganti paket latihan aktif
    packageSelector.addEventListener('change', (e) => {
        setActivePackage(e.target.value);
    });


    // Modal Events
    manageBtn.addEventListener('click', () => {
      populateDataList(); // Isi ulang daftar pairs dari paket aktif
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    closeModalBtn.addEventListener('click', () => {
      shuffle();
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      confirmDelete.classList.add('hidden'); // Pastikan konfirmasi tersembunyi
    });

    // Tutup modal jika mengklik background
    modal.addEventListener('click', (e) => {
        if (e.target.id === 'modal') {
            closeModalBtn.click();
        }
    });

    // NEW: Tambah Paket
    addPackageBtn.addEventListener('click', async () => {
        const name = newPackageNameInput.value.trim();
        if (name) {
            await addNewPackage(name);
            newPackageNameInput.value = '';
        } else {
            showToast("Nama paket tidak boleh kosong.", 'info');
        }
    });

    // --- FIX: Tombol Hapus Paket dan Konfirmasi ---
    
    // 1. Tombol Hapus: Menampilkan konfirmasi (menggantikan window.confirm)
    deletePackageBtn.addEventListener('click', async () => {
        if (deletePackageBtn.disabled) {
            showToast("Tidak bisa menghapus paket terakhir.", 'info');
            return;
        }
        confirmDelete.classList.remove('hidden');
        // Sembunyikan setelah 5 detik jika tidak ada aksi
        setTimeout(() => {
            if (!confirmDelete.classList.contains('hidden')) {
                confirmDelete.classList.add('hidden');
            }
        }, 5000); 
    });

    // 2. Konfirmasi Ya: Lanjutkan penghapusan
    confirmYes.addEventListener('click', async () => {
        confirmDelete.classList.add('hidden');
        await deleteActivePackage();
    });

    // 3. Konfirmasi Batal: Sembunyikan
    confirmNo.addEventListener('click', () => {
        confirmDelete.classList.add('hidden');
        showToast("Penghapusan paket dibatalkan.", 'info');
    });


    // Event Simpan Data (Multi-baris)
    saveBtn.addEventListener('click', async () => {
        if (!activePackage) {
            showToast("Tidak ada paket aktif untuk menyimpan data.", 'error');
            return;
        }
        const pinyinText = inputPinyin.value;
        const hanziText = inputHanzi.value;

        if (!pinyinText.trim() || !hanziText.trim()) {
            showToast("Input Pinyin atau Hanzi kosong.", 'info');
            return;
        }

        const addedCount = await addMultiLinePairs(pinyinText, hanziText);

        if (addedCount > 0) {
            inputPinyin.value = '';
            inputHanzi.value = '';
            showToast(`${addedCount} pasangan data baru berhasil ditambahkan!`, 'success');
        } else {
            showToast("Tidak ada pasangan data baru yang ditambahkan (mungkin duplikat).", 'info');
        }
    });

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
      await loadData(); // Muat semua paket dan set paket aktif
      resizeCanvas();
    });

    // Debounced resize handler
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(resizeCanvas, 100);
    });
  </script>
</body>
</html>

